{"version":3,"file":"bundle.js","sources":["../src/utils.ts","../src/index.ts"],"sourcesContent":["export function randomId () {\n  return Math.random().toString(16).substr(3, 6)\n}\n\nexport function upUntil (cls: string, el: HTMLElement): HTMLElement {\n  if (el === document.body || el.classList.contains(cls)) {\n    return el\n  }\n  return upUntil(cls, el.parentElement!)\n}\n\nexport function getId (box: HTMLElement) {\n  return (box.querySelector('[data-target=id]') as HTMLInputElement).value\n}\n\nexport function getPrompt (box: HTMLElement) {\n  return (box.querySelector('[data-target=prompt]') as HTMLInputElement).value\n}\n\nexport function getResponses (box: HTMLElement) {\n  return Array.from(box.querySelectorAll('.response')).map(resp => {\n    return {\n      match: resp.querySelector('input')!.value,\n      message: resp.querySelector('textarea')!.value\n    }\n  })\n}\n","import { MessageBot, MessageBotExtension, Player } from '@bhmb/bot'\nimport { UIExtensionExports } from '@bhmb/ui'\n\nimport { randomId, upUntil, getId, getPrompt, getResponses } from './utils'\n\nimport html from './tab.html'\n\ninterface MessageInfo {\n  id: string\n  prompt: string\n  responses: { match: string, message: string }[]\n}\nconst KEY = 'prompts'\n\nfunction initListeners (ex: MessageBotExtension) {\n  function getPrompts () {\n    return ex.storage.get(KEY, [] as MessageInfo[])\n  }\n\n  // name => prompt id\n  const prompts = new Map<string, string>()\n\n  function startPrompt (message: string) {\n    const [, id = '', name = ''] = message.match(/([^ ]+) (.*)/) || []\n    const player = ex.world.getPlayer(name)\n    if (!player.hasJoined) {\n      ex.bot.send('Failed to start prompt for {{Name}}, they have never joined.', { name })\n      return\n    }\n\n    const prompt = getPrompts().find(p => p.id.trim().toLocaleLowerCase() === id.trim().toLocaleLowerCase())\n\n    if (!prompt) {\n      ex.bot.send(`Failed to start prompt ${id} for {{Name}}, not found.`, { name: player.name })\n      return\n    }\n\n    ex.bot.send(prompt.prompt, { name: player.name })\n    prompts.set(player.name, prompt.id)\n  }\n\n  function checkPrompts (player: Player, chat: string) {\n    const promptId = prompts.get(player.name)\n    prompts.delete(player.name)\n    if (!promptId) return // Nothing to do. No active prompts\n\n    const prompt = getPrompts().find(p => p.id === promptId)\n    if (!prompt) return // User edited prompt id before they responded. Cancel\n\n    for (const { match, message } of prompt.responses) {\n      if (chat.toLocaleLowerCase().includes(match)) {\n        ex.bot.send(message, { name: player.name })\n        return\n      }\n    }\n  }\n\n  function listen ({ player, message }: { player: Player, message: string }) {\n    const lowerMessage = message.toLocaleLowerCase()\n    if (player.name === 'SERVER' && lowerMessage.startsWith('/prompt ')) {\n      startPrompt(message.substr('/prompt '.length))\n    } else if (name !== 'SERVER') {\n      checkPrompts(player, message)\n    }\n  }\n\n  ex.world.onMessage.sub(listen)\n  return () => ex.world.onMessage.unsub(listen)\n}\n\nfunction initUi (tab: HTMLElement, ui: UIExtensionExports, ex: MessageBotExtension) {\n  const addButton = tab.querySelector('.is-adding-message') as HTMLButtonElement\n  const promptTemplate = tab.querySelector('template[data-for=prompt]') as HTMLTemplateElement\n  const responseTemplate = tab.querySelector('template[data-for=response]') as HTMLTemplateElement\n  const container = tab.querySelector('.messages-container') as HTMLElement\n\n  function addMessage (info: MessageInfo) {\n    ui.buildTemplate(promptTemplate, container, [\n      { selector: '[data-target=summary]', text: `${info.id} -> ${info.prompt}` },\n      { selector: '[data-target=id]', value: info.id },\n      { selector: '[data-target=prompt]', value: info.prompt }\n    ])\n    const box = container.querySelector('.box:last-child') as HTMLElement\n    const responseContainer = box.querySelector('.responses-container') as HTMLElement\n    for (const resp of info.responses) {\n      ui.buildTemplate(responseTemplate, responseContainer, [\n        { selector: 'input', value: resp.match },\n        { selector: 'textarea', value: resp.message }\n      ])\n    }\n  }\n\n  ex.storage.get<MessageInfo[]>(KEY, []).forEach(addMessage)\n  function save () {\n    const data: MessageInfo[] = Array.from(container.querySelectorAll<HTMLElement>('.box')).map(box => {\n      return {\n        id: getId(box),\n        prompt: getPrompt(box),\n        responses: getResponses(box)\n      }\n    })\n\n    ex.storage.set(KEY, data)\n  }\n\n  addButton.addEventListener('click', () => {\n    const id = randomId()\n    addMessage({ id, prompt: '', responses: [] })\n  })\n\n  container.addEventListener('input', ev => {\n    const target = ev.target as HTMLElement\n    if (['id', 'prompt'].includes(target.dataset.target || '')) {\n      const box = upUntil('box', target)\n      box.querySelector('summary')!.textContent = `${getId(box)} -> ${getPrompt(box)}`\n    }\n\n    save()\n  })\n\n  container.addEventListener('click', ev => {\n    const target = ev.target as HTMLElement\n    if (target.dataset.do === 'add-response') {\n      const box = upUntil('box', target)\n      const container = box.querySelector('.responses-container') as HTMLElement\n      ui.buildTemplate(responseTemplate, container, [])\n    }\n  })\n}\n\nMessageBot.registerExtension('bibliofile/prompts', ex => {\n  const removeListeners = initListeners(ex)\n  ex.remove = removeListeners\n\n  const ui = ex.bot.getExports('ui') as UIExtensionExports | undefined\n  if (!ui) return\n\n  const tab = ui.addTab('Prompts', 'messages')\n  tab.innerHTML = html\n  initUi(tab, ui, ex)\n\n  ex.remove = () => {\n    removeListeners()\n    ui.removeTab(tab)\n  }\n})\n"],"names":["MessageBot"],"mappings":"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"}